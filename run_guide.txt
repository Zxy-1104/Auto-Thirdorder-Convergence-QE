# ðŸš€ Usage Guide

## ðŸ“‚ 1. Preparation (Prerequisites)

Before running the workflow, ensure your project root directory contains the following files and folders:

* **`pseudo/`**: Directory containing pseudopotential files (`.UPF`).
* **`ShengBTE/`**: Directory containing:
* `CONTROL`: ShengBTE control file.
* `espresso.ifc2`: 2nd-order force constants file.


* **`*_unit.scf.in`**: Unit cell self-consistent field (SCF) input file.
* **`*_supper.scf.in`**: Supercell template file.
* **`templates/`**: Directory containing submission scripts:
* `sub_calc.sh` (for DFT/Supercell calculation)
* `sub_gen.sh` (for 3rd-order FC generation)
* `sub_sheng.sh` (for Thermal conductivity calculation)



## ðŸ› ï¸ 2. Environment Setup

Ensure you are running in the project root directory and have **Python 3** loaded.

```bash
# Check available python versions on the cluster
module avail python   

# Load the required python version (replace * with version number, e.g., 3.8)
module load python/* # Verify python version (Ensure it is Python 3.x)
python --version      

```

---

## âš¡ 3. Step-by-Step Workflow

If you prefer to run the workflow stage by stage, follow these commands:

### Phase 1: Pre-processing

```bash
# Step 1: Generate Supercells
# Generates folders and DISP input files for all configurations defined in INPUT.
python convergence.py generate

# Step 2: Structure Deduplication
# Identifies identical atomic structures and creates symlinks to avoid redundant calculations.
python convergence.py link

# (Optional) Cost Analysis
# Analyze how much computational resource is saved by deduplication.
python convergence.py analyze

```

### Phase 2: DFT Calculation (Quantum Espresso)

```bash
# Step 3: Submit DFT Jobs
# Submits Job Arrays based on resource configs in 'templates/sub_calc.sh'.
python convergence.py submit_dft

# ... Wait for all DFT jobs on the cluster to finish ...

# Step 4: Generate 3rd-Order Force Constants
# Automatically checks DFT completeness and calls 'thirdorder_espresso.py reap'.
# If prompted [Wait] Incomplete, check job status or re-run failed tasks.
python convergence.py gen_fc3

```

### Phase 3: Thermal Conductivity (ShengBTE)

```bash
# Step 5: Submit ShengBTE Jobs
# Distributes force constants to the ShengBTE/ directory and submits calculations.
python convergence.py run_bte

# ... Wait for ShengBTE jobs on the cluster to finish ...

```

### Phase 4: Post-processing

```bash
# Step 6: Collect Results
# Extracts thermal conductivity data from all tasks and generates 'kappa_summary.json'.
python convergence.py collect

# Step 7: Plot Convergence Curves
# Generates PRB-style convergence comparison plots (PNG format) based on collected data.
python convergence.py plot

```

---

## ðŸ”¥ 4. One-Click Automation (Recommended)

To execute the entire workflow (Phase 1 to 4) automatically in the background:

### Start Automation

Use `nohup` to keep the script running even if your SSH connection drops.

```bash
nohup python convergence.py auto > auto.log 2>&1 &

```

### Monitor Progress

Check the automation logs in real-time. Press **`Ctrl + C`** to exit the view mode.

```bash
tail -f auto.log

```

### Stop Automation & Cancel Jobs

If you need to stop the workflow halfway:

1. **Kill the Python Script (The Controller):**
```bash
# Find the PID (Process ID)
ps -ef | grep convergence.py

# Kill the process (Replace <PID> with the actual number found above)
kill -9 <PID>

```


2. **Cancel Cluster Jobs (The Calculations):**
```bash
# Check your running jobs
squeue -u <your_username>

# Cancel specific jobs
scancel <JOBID>

# OR Cancel ALL jobs belonging to you (Use with caution!)
scancel -u <your_username>

```
